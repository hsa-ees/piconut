#!/bin/bash

#  (C) 2023 Gundolf Kiefer <gundolf.kiefer@tha.de>
#      2024 Lukas Bauer <lukas.bauer1@tha.de>
#
#           Efficient Embedded Systems Group
#           Augsburg Technical University of Applied Sciences
#
#  This program is free software: you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation, either version 3 of the License, or
#  (at your option) any later version.
#
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with this program.  If not, see <http://www.gnu.org/licenses/>.


VERSION=0.9

TOOL="${0##*/}"
CMDLINE="${0##*/} $@"

if [[ "$ICSC_HOME" != "" ]]; then
  if [ -f "$ICSC_HOME/setenv.sh" ] ; then
    . $ICSC_HOME/setenv.sh
  else
    echo "ERROR: '$ICSC_HOME/setenv.sh' not found (ICSC_HOME=$ICSC_HOME)."
    exit 1
  fi
else
  echo "ERROR: Environment variable 'ICSC_HOME' is not set."
  exit 1
fi





######################### SystemC-RTL Synthesis ################################


do_icsc_synthesis () {
  # Arguments: <DESIGN> <TOPLEVEL> <input_dir> <output_dir> <output_filename> <sources>
  DESIGN="$1"
  TOPLEVEL="$2"
  INPUT_DIR="$3"
  OUTPUT_DIR="$4"
  OUTPUT_FILENAME="$5"
  DELETE_BUILD_DIR="$6"

  # get the number of defines and read them into the DEFINES variable
  DEFINES_CNT="$7"
  shift 7
  DEFINES=""
  while [[ $DEFINES_CNT -gt 0 ]]; do
    DEFINES="$DEFINES $1"
    shift
    DEFINES_CNT=$((DEFINES_CNT-1))
  done

  SOURCES=""
  PROJECT_SOURCE_DIR="../.."
  OUTPUT_FILE_PATH="../../$DESIGN.v"

  if [[ "$INPUT_DIR" == "" ]]; then
    for S in $@; do SOURCES="$SOURCES $S"; done
  else
    SOURCES=$(find "$INPUT_DIR" -name "*.cpp" -exec printf "../../%s " {} +)
    PROJECT_SOURCE_DIR="../../$INPUT_DIR"
  fi

  if [[ "$OUTPUT_DIR" != "" ]]; then
    mkdir --parents $OUTPUT_DIR
    OUTPUT_FILE_PATH="../../$OUTPUT_DIR/$OUTPUT_FILENAME.v"
  fi

  # Prepare build directory ...
  BUILD=$DESIGN-ees/icsc
  rm -fr $BUILD
  mkdir -p $BUILD

  # Create 'CMakeLists.txt' ...
  cat > $DESIGN-ees/icsc/CMakeLists.txt << EOF
cmake_minimum_required(VERSION 3.18)

project($DESIGN)
find_package(SVC REQUIRED)

set(PROC_TECH fpga)
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -std=c++17")

enable_testing()

add_compile_options(-Wall -ggdb -O0)
add_executable($DESIGN $SOURCES)
target_include_directories($DESIGN PUBLIC "${PROJECT_SOURCE_DIR}")
target_compile_definitions($DESIGN PUBLIC -D__SYNTHESIS__ $DEFINES)

svc_target($DESIGN ELAB_TOP $TOPLEVEL)
EOF

  #Run synthesis steps ...
  cd $BUILD

  echo
  echo "ICSC: Preparing ..."
  echo
  cmake . || exit 1

  echo
  echo "ICSC: Compiling ..."
  echo
  make -j8 || exit 1    # TBD: make parallelism configurable

  echo
  echo "ICSC: Synthsizing ..."
  echo
  ./${DESIGN}_sctool || exit 1

  echo "$PROJECT_SOURCE_DIR $(pwd)"
  # copy additional verilog files to sv_out before running sv2v
  if [[ -d "$PROJECT_SOURCE_DIR/verilog" ]]; then
    echo "Copying additional verilog files to sv_out/verilog ..."
    mkdir -p sv_out/verilog
    cp -Lr $PROJECT_SOURCE_DIR/verilog/* sv_out/verilog/
  fi

  echo
  echo "Converting output to Verilog ..."
  echo

  sv2v sv_out/${DESIGN}.sv > $OUTPUT_FILE_PATH || exit 1

  if [[ $DELETE_BUILD_DIR == 1 ]]; then

    cd ../..

    echo
    echo "Cleaning up $DESIGN-ees/ directory ..."
    echo

    rm -fr $DESIGN-ees
  fi
}




############################## Main ############################################


# Usage and error helpers...
usage () {
  echo "Usage: $TOOL [<options>] <SystemC C++ sources without headers>"
  echo
  echo "Synthesize a SystemC/RTL design to Verilog using the IntelÂ® Compiler for SystemC (ICSC)."
  echo
  echo "Options:"
  echo
  echo "  -i <path>"
  echo "      specify path to the directory containing all SystemC C++ sources"
  echo "      this does disable the manual specification of the sources on the command line"
  echo
  echo "  -o <path>"
  echo "      specify path to the directory where the generated Verilog file should be placed"
  echo
  echo "  -O <filename>"
  echo "      specify the name of the generated Verilog file"
  echo
  echo "  -R"
  echo "      delete the ICSC build directory after synthesis"
  echo
  echo "  -D <define>"
  echo "     specify a define for the SystemC C++ sources"
  echo "     (e.g. -D -DDEBUG)"
  echo
  echo "  -d <design name> [ Default: base name of the first C++ file specified ]"
  echo "      specify the ICSC project name"
  echo
  echo "  -t <top-level> [ Mandatory ]"
  echo "      specify the name of the top-level module"
  echo
  echo "  -s supresses the usage text when an error occurs"
  echo
  echo "Generated outputs:"
  echo
  echo "  <design name>-ees/icsc :  ICSC build directory (can be removed)"
  echo "  <design name>.v :         generated Verilog file"
  echo
  echo "  Note: The generated Verilog files path can be changed using the -o option."
  echo
}


error () {
  echo
  echo "ERROR: $1"
  echo
  if [[ $SUPRESS_USAGE == 0 ]]; then
    usage
  fi
  exit 3
}


# Parse options...
DESIGN=""
TOPLEVEL=""
INPUT_DIR=""
INPUT_DIR_SET=0
OUTPUT_DIR=""
OUTPUT_DIR_SET=0
OUTPUT_FILENAME=""
OUTPUT_FILENAME_SET=0
DELETE_BUILD_DIR=0
DEFINES=""
DEFINES_CNT=0
SUPRESS_USAGE=0
PARSE_OPTS="1"
while [[ $PARSE_OPTS == "1" ]]; do
  case "$1" in
    -i)
      INPUT_DIR=$(realpath --relative-to=$(pwd) "$2")
      INPUT_DIR_SET=1
      shift 2
      ;;
    -o)
      OUTPUT_DIR=$(realpath --relative-to=$(pwd) "$2")
      OUTPUT_DIR_SET=1
      shift 2
      ;;
    -O)
      OUTPUT_FILENAME="$2"
      OUTPUT_FILENAME_SET=1
      shift 2
      ;;
    -R)
      DELETE_BUILD_DIR=1
      shift
      ;;
    -D)
      DEFINES="$DEFINES $2"
      DEFINES_CNT=$((DEFINES_CNT+1))
      shift 2
      ;;
    -d)
      DESIGN="$2"
      shift 2
      ;;

    -t)
      # check if the next argument starts with -
      if [[ $2 == -* ]]; then
        error "Missing argument for option '-t'"
      fi

      TOPLEVEL="$2"
      shift 2
      ;;

    -s)
      SUPRESS_USAGE=1
      shift 1
      ;;

    -*)
      error "Unknown option '$1'"
      ;;

    *)
      PARSE_OPTS="0"
      ;;

  esac
done
if [[ "$DESIGN" == "" && $INPUT_DIR_SET == 0 ]]; then
  DESIGN=${1%.*}
else
  DESIGN=$(basename $INPUT_DIR)
fi

# Determine output file name if non was given...
if [[ $OUTPUT_FILENAME_SET == 0 ]]; then
  OUTPUT_FILENAME="$DESIGN"
fi

# Check if all Defines of the format -D<DEFINE>
for DEFINE in $DEFINES; do
  if [[ ! $DEFINE =~ ^-D.*$ ]]; then
    error "Invalid define: $DEFINE"
  fi
done


# Sanity checks...
if [[ ( $INPUT_DIR_SET == 0 && "$1" == "" ) || "$DESIGN" == "" || "$TOPLEVEL" == "" \
     || ( $OUTPUT_DIR_SET == 1 && "$OUTPUT_DIR" == "" ) \
     || ( $INPUT_DIR_SET == 1 && "$INPUT_DIR" == "" ) ]]; then
  usage
  exit
fi

# Go ahead...
do_icsc_synthesis $DESIGN $TOPLEVEL $INPUT_DIR $OUTPUT_DIR $OUTPUT_FILENAME $DELETE_BUILD_DIR $DEFINES_CNT $DEFINES $@
